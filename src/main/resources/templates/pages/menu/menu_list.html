<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="UTF-8">
        <title>菜单列表</title>
        <script th:replace="include.html"></script>
    </head>
    <body>
        <div id="main">
            <!--条件-->
            <el-form :inline="true" :model="query" class="demo-form-inline">
                <el-form-item label="菜单名称">
                    <el-input v-model="query.menuName" placeholder="菜单名称"></el-input>
                </el-form-item>
                <el-form-item label="菜单类型">
                    <el-select v-model="query.menuType" >
                        <el-option label="请选择" value=""></el-option>
                        <el-option label="目录" value="M"></el-option>
                        <el-option label="菜单" value="C"></el-option>
                        <el-option label="按钮" value="F"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="getMenuList">查询</el-button>
                </el-form-item>
            </el-form>
            <!--按钮-->
            <el-row>
                <el-button type="primary" plain icon="el-icon-plus" @click="addUser">新增</el-button>
                <el-button type="danger" plain  icon="el-icon-delete" @click="deleteUser">删除</el-button>
            </el-row>
            <!--表单-->
            <el-table
                    ref="multipleTable"
                    :data="tableData"
                    border
                    style="width: 100%;margin-top: 5px"
                    @selection-change="handleSelectionChange"
                    v-loading="loading"
                    row-key="id"
                    default-expand-all
                    :tree-props="{children: 'children', hasChildren: 'hasChildren'}"
            >
                <el-table-column
                        prop="id"
                        type="selection"
                        width="55"
                >
                </el-table-column>
                <el-table-column
                        fixed
                        prop="menuName"
                        label="菜单名称"
                        width="150">
                </el-table-column>
                <el-table-column
                        prop="parentName"
                        label="父级名称"
                        width="150">
                </el-table-column>
                <el-table-column
                        prop="orderNum"
                        label="排序号"
                        width="70">
                </el-table-column>
                <el-table-column
                        prop="menuType"
                        label="菜单类型"
                        width="80"
                        :formatter="table_menuType_formatter"
                >
                </el-table-column>
                <el-table-column
                        prop="path"
                        label="请求路径"
                        width="300">
                </el-table-column>
                <el-table-column
                        prop="perms"
                        label="权限标识"
                        width="180"
                >
                </el-table-column>
                <el-table-column
                        prop="icon"
                        label="菜单图标"
                        width="150"
                >
                </el-table-column>
                <el-table-column
                        prop="remark"
                        label="备注"
                        width="180">
                </el-table-column>
                <el-table-column
                        prop="createTime"
                        label="创建时间"
                        width="120">
                </el-table-column>
                <el-table-column
                        prop="updateTime"
                        label="更新时间"
                        width="120">
                </el-table-column>
                <el-table-column
                        label="操作"
                        width="100">
                    <template slot-scope="scope">
                        <el-button type="text" @click="editUser(scope.row)" size="small">编辑</el-button>
                        <el-button type="text" size="small"  sec:authorize="hasAuthority('system:user:list')" >授权</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <!--分页-->
            <div class="block">
                <el-pagination
                        @size-change="handleSizeChange"
                        @current-change="handleCurrentChange"
                        :current-page=page.currentPage
                        :page-sizes="[1,5,10,20,50]"
                        :page-size=page.pageSize
                        layout="total, sizes, prev, pager, next, jumper"
                        :total=page.total>
                </el-pagination>
            </div>

            <!--新增dialog,@click="dialogAddUserForm = true"打开，@click="dialogAddUserForm = false" 关闭 -->
            <!-- dialog 表单 -->
            <el-dialog :title="getUserEditTitle"
                       :visible.sync="dialogAddUserForm"
                       @close="closeAddUserForm"
                       :before-close="beforeCloseAddUserDialog"
            >
                <el-form :model="menu" :rules="rules" ref="menuForm" label-position="left" label-width="80px">
                    <el-input v-model="menu.id" autocomplete="off" type="hidden"></el-input>
                    <el-form-item prop="menuType" label="菜单类型"  >
                        <template>
                            <el-radio-group v-model="menu.menuType">
                                <el-radio label="M">目录</el-radio>
                                <el-radio label="C">菜单</el-radio>
                                <el-radio label="F">按钮</el-radio>
                            </el-radio-group>
                        </template>
                    </el-form-item>
                    <el-form-item prop="parentId" label="主目录" >
                        <el-select class="main-select-tree" ref="selectTree" v-model="menu.parentId"  >
                            <el-option v-for="item in formatData(datas)" :key="item.value" :label="item.label" :value="item.value" style="display: none" > </el-option>
                            <el-tree class="main-select-el-tree" ref="selecteltree"
                                     :data="datas"
                                     node-key="id"
                                     highlight-current
                                     :props="defaultProps"
                                     @node-click="handleNodeClick"
                                     :current-node-key="value"
                                     :expand-on-click-node="expandOnClickNode"
                                     default-expand-all />
                        </el-select>
                    </el-form-item>
                    <el-form-item prop="username" label="菜单名称" >
                        <el-input v-model="menu.menuName" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item prop="orderNum" label="排序号" >
                        <el-input v-model="menu.orderNum" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item  prop="path" label="请求路径" >
                        <el-input v-model="menu.path" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item  prop="perms" label="权限标识" >
                        <el-input v-model="menu.perms" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item prop="icon" label="图标" >
                        <el-input v-model="menu.icon" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item prop="remark" label="备注" >
                        <el-input v-model="menu.remark" autocomplete="off"></el-input>
                    </el-form-item>
                </el-form>
                <div slot="footer" class="dialog-footer">
                    <el-button @click="closeUserDialog">取 消</el-button>
                    <el-button type="primary" @click="submitUserForm('userForm')">确 定</el-button>
                </div>
            </el-dialog>

        </div>
        <script>
            new Vue({
                el:'#main',
                data() {
                    return {
                        tableData: [],
                        query:{
                            menuName:'',
                            menuType:''
                        },
                        menu:{
                            id:'',
                            menuName:'',
                            parentId:'',
                            orderNum:'',
                            path:'',
                            perms:'',
                            menuType:'',
                            createTime:'',
                            updateTime:'',
                            remark:'',
                            icon:''
                        },
                        rules: {
                            username: {
                                required: true,
                                message: '请输入用户名',
                                trigger: 'blur'
                            },
                            password: {
                                required: true,
                                message: '请输入密码',
                                trigger: 'blur'
                            },
                            nickName: {
                                required: true,
                                message: '请输入昵称',
                                trigger: 'blur'
                            },
                            phone: {
                                required: true,
                                message: '请输入手机号',
                                trigger: 'blur'
                            },
                            address: {
                                required: true,
                                message: '请输入地址信息',
                                trigger: 'blur'
                            },
                            sex: {
                                required: true,
                                message: '请选择性别',
                                trigger: 'blur'
                            },
                        },
                        isUserEdit:true, //是否编辑
                        multipleSelection: [], //复选框选择的列
                        dialogAddUserForm: false, //新增窗口默认关闭
                        loading: true, //是否显示loading
                        page:{
                            currentPage:1,
                            total:1,
                            pageSize: 10
                        },

                        value: 6,
                        expandOnClickNode: true,
                        options:[],
                        datas: [{
                            id: 1,
                            label: '云南',
                            children: [{
                                id: 2,
                                label: '昆明',
                                children: [
                                    {id: 3,label: '五华区',children:[{id: 8,label: '北辰小区'}]},
                                    {id: 4,label: '盘龙区'}
                                ]
                            }]
                        }, {
                            id: 5,
                            label: '湖南',
                            children: [
                                {id: 6,label: '长沙'},
                                {id: 7,label: '永州'}
                            ]
                        }],
                        defaultProps: {
                            children: 'children',
                            label: 'label'
                        }

                    }
                },
                //加载完成
                mounted() {
                    this.getMenuList();
                },
                computed:{
                    getUserEditTitle(){
                        return this.isUserEdit ? '新增用户' : '修改用户';
                    }
                },
                methods:{
                    handleNodeClick(node){
                        this.value = node.id;
                        this.$refs.selectTree.blur();
                    },
                    // 巧妙的利用了select组件的渲染方式，通过隐藏options来动态计算下拉高度，通过模型同步实现了select组件渲染，不必赋值，同步模型。
                    formatData(data){
                        let options = [];
                        data.forEach((item,key) => {
                            options.push({label:item.label,value:item.id});
                            if(item.children){
                                item.children.forEach((items,keys) => {
                                    options.push({label:items.label,value:items.id});
                                    if(items.children){
                                        items.children.forEach((itemss,keyss) => {
                                            options.push({label:itemss.label,value:itemss.id});
                                            if(itemss.children){
                                                itemss.children.forEach((itemsss,keysss) => {
                                                    options.push({label:itemsss.label,value:itemsss.id});
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                        });
                        return options;
                    },
                    //复选框选中
                    handleSelectionChange(val) {
                        this.multipleSelection = val;
                    },
                    //页数大小改变
                    handleSizeChange(val) {
                        this.page.pageSize = val;
                        this.page.currentPage = 1;
                        this.getMenuList(); //查询一次数据
                    },
                    //当前页码改变
                    handleCurrentChange(val) {
                        this.page.currentPage = val;
                        this.getMenuList(); //查询一次数据
                    },
                    //查询菜单列表
                    getMenuList(){
                        var that = this;
                        that.loading = true;
                        //获取参数
                        var param = {};
                        param.menuName = this.query.menuName;
                        param.menuType = this.query.menuType;
                        param.pageSize= this.page.pageSize;
                        param.pageNum = this.page.currentPage;
                        axios.post(path+'system/menu/list',param).then(
                            (res) => {
                                that.loading = false;
                                if(res.data.code == '200'){
                                    this.page.total = res.data.total;
                                    this.tableData = res.data.data;
                                }else{
                                    this.$message.error(res.data.msg);
                                }
                            })
                            .catch((err) => {
                                that.loading = false;
                                console.log(err)
                                this.$message.error('系统错误');
                            })
                    },
                    // 表格格式化,菜单类型这一列
                    table_menuType_formatter(row, column, cellValue, index) {
                        if(cellValue == "M"){
                            return "目录"
                        }else if(cellValue == 'C'){
                            return "菜单"
                        }else if(cellValue == 'F'){
                           return "按钮"
                        }else{
                            return cellValue;
                        }
                    },
                    //格式图标
                    table_icon_formatter:function(row, column, cellValue, index){
                        return '<i class="'+cellValue+'"></i>'
                    },
                    //删除
                    deleteUser(){
                        // 方法一，通过selection-change 事件获取
                        var deleteUsers = this.multipleSelection; //选中的行
                        if(deleteUsers.length < 1){
                            return this.$message.warning('请选择删除的行!');
                        }
                        var userIds = "";
                        for(var i=0;i<deleteUsers.length;i++){
                            if(i === deleteUsers.length-1 ){
                                userIds += deleteUsers[i].id;
                            }else{
                                userIds += deleteUsers[i].id + ",";
                            }
                        }
                        //是否确认删除
                        this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            axios.post('/user/delete',{userIds:userIds})
                                .then(
                                    (res) => {
                                        console.log("aaaa",res)
                                        if(res.data.code == '200'){
                                            this.$message.success(res.data.msg);
                                            this.getMenuList();
                                        }else{
                                            this.$message.error(res.data.msg);
                                        }
                                    })
                                .catch((err) => {
                                    console.log(err)
                                    this.$message.error('系统错误');
                                })
                        }).catch(() => {
                            this.$message({
                                type: 'info',
                                message: '已取消删除'
                            });
                        });
                    },
                    //打开新增/编辑窗口
                    openUserDialog(){
                        this.dialogAddUserForm = true
                    },
                    //关闭新增/编辑窗口
                    closeUserDialog(){
                        this.closeAddUserForm();
                    },
                    //提交用户添加/编辑表单
                    submitUserForm:function (formName) {
                        this.$refs[formName].validate((valid) => {
                            if (valid) {
                                axios.post('/user/addOrUpdateUser',this.user)
                                    .then((res) => {
                                        //console.log(res)
                                        if(res.data.code == '200'){
                                            this.getMenuList();
                                            this.$message.success(res.data.msg);
                                            this.closeUserDialog();
                                        }else{
                                            this.$message.error(res.data.msg);
                                        }
                                    })
                                    .catch((err) => {
                                        console.log(err)
                                        this.$message.error('系统错误');
                                    })
                            } else {
                                console.log('error add user submit!!');
                                return false;
                            }
                        });
                    },
                    //新增用户
                    addUser(){
                        this.isUserEdit = false;
                        this.user = {
                            id:'',
                            username:'',
                            password:'',
                            nickName:'',
                            phone:'',
                            sex:'',
                            address:''
                        };
                        this.openUserDialog();
                    },
                    //编辑用户
                    editUser(row){
                        // console.log(row)
                        this.isUserEdit = true;
                        this.user = row;
                        //console.log("update",this.user)
                        this.openUserDialog();
                    },
                    //点击右上角的X关闭弹窗
                    closeAddUserForm(){
                        this.isUserEdit = false;
                        this.dialogAddUserForm = false //关闭
                    },
                    //关闭窗口前的回调
                    beforeCloseAddUserDialog(){

                    }
                }
            })
        </script>
    </body>
</html>